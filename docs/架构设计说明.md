# 基金代销系统 - 申购业务架构设计说明

## 1. 整体架构

### 1.1 架构风格

本系统采用以下架构模式和设计原则:

- **领域驱动设计(DDD)**: 通过限界上下文划分业务领域，使用战术模式构建领域模型
- **六边形架构(Hexagonal Architecture)**: 领域逻辑在核心，外部依赖通过端口和适配器隔离
- **微服务就绪**: 每个限界上下文可独立演进，为未来微服务化做准备
- **事件驱动**: 使用领域事件实现限界上下文间的松耦合通信

### 1.2 限界上下文划分

```
┌─────────────────────────────────────────────────────────┐
│                    Fund Sale System                      │
├─────────────────────────────────────────────────────────┤
│                                                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │   Product    │  │   Customer   │  │   Marketing  │ │
│  │   Context    │  │   Context    │  │   Context    │ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│                                                          │
│  ┌────────────────────────────────────────────────────┐│
│  │          Trading Context (Core)                     ││
│  │  - Subscription Transaction (Aggregate Root)        ││
│  │  - Validation Service                               ││
│  │  - Accounting Service (Strategy Pattern)            ││
│  │  - Rollback Service (Saga Compensation)             ││
│  └────────────────────────────────────────────────────┘│
│                                                          │
│  ┌────────────────────────────────────────────────────┐│
│  │     Anti-Corruption Layer (ACL)                     ││
│  │  - CoreBankingService Interface                     ││
│  │  - MarketingCouponService Interface                 ││
│  └────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────┘
```

## 2. 核心设计模式

### 2.1 Saga模式 - 分布式事务处理

由于申购流程涉及多个外部系统调用(营销系统、核心银行系统)，采用Saga模式处理分布式事务:

```
Step 1: Save Transaction (Local TX)  → 成功
   ↓
Step 2: Use Coupon (Marketing)       → 成功 [需补偿]
   ↓
Step 3: Accounting (Core Bank)       → 成功 [需补偿]
   ↓
Step 4: Update Status (Local TX)     → 成功
   ↓
Complete

失败场景:
Step 3 失败 → Compensation: 还券 (Async)
```

**Saga状态追踪**:
- `INIT`: 初始状态
- `REQUEST_SAVED`: 请求已保存
- `COUPON_USED`: 优惠券已使用(需补偿)
- `ACCOUNTING_COMPLETED`: 记账完成(需冲正)
- `FREEZE_COMPLETED`: 冻结完成(需解冻)
- `COMPLETED`: 全部完成

### 2.2 策略模式 - 记账场景处理

不同条件下需要调用不同的核心系统接口，使用策略模式:

```java
AccountingStrategy strategy = selectStrategy(productCurrency, accountCurrency);
- ExchangeAndAccountingStrategy: 需要外币兑换
- DirectAccountingStrategy: 交易时间内直接记账
- FreezeStrategy: 非交易时间冻结
```

**优势**:
- 开放封闭原则: 易于添加新的记账策略
- 单一职责: 每个策略专注于一种场景
- 可测试性: 每个策略可独立测试

### 2.3 防腐层(ACL) - 外部系统隔离

通过接口定义隔离外部系统，防止外部变化污染领域模型:

```
Domain Model  →  ACL Interface  →  Adapter  →  External System
                  (定义在common)   (未实现)     (核心/营销系统)
```

## 3. 领域模型设计

### 3.1 聚合根: SubscriptionTransaction

**职责**:
- 封装完整的申购交易生命周期
- 强制业务不变性(金额、状态一致性)
- 管理状态转换(INIT → VALIDATED → ACCOUNTING → COMPLETED)
- 追踪Saga状态以支持补偿

**关键方法**:
- `initialize()`: 初始化交易
- `markValidated()`: 标记校验通过
- `markCouponUsed()`: 标记优惠券已使用
- `markAccountingCompleted()`: 标记记账完成
- `markCompleted()`: 标记交易完成
- `markFailed()`: 标记交易失败

### 3.2 值对象

- **Money**: 不可变的金额对象，封装货币和金额
- **TransactionAmount**: 带验证的交易金额
- **RiskLevel**: 风险等级(1-5)，带匹配逻辑
- **CouponInfo**: 优惠券信息和折扣计算
- **FeeCalculation**: 费用计算结果

### 3.3 领域服务

**SubscriptionValidationService**:
- 产品校验(状态、渠道)
- 客户校验(账户有效性、风险匹配)
- 金额校验(最小/最大、单位)
- 额度校验(TA日累计限额)

**AccountingService**:
- 策略选择
- 记账执行
- 断路器保护

**TransactionRollbackService**:
- 异步补偿执行
- 重试机制
- 补偿结果追踪

## 4. 技术实现亮点

### 4.1 断路器模式

使用Resilience4j保护外部系统调用:

```yaml
circuitbreaker:
  instances:
    coreBank:
      sliding-window-size: 10
      failure-rate-threshold: 50
      wait-duration-in-open-state: 60000
```

**保护范围**:
- 核心银行系统调用
- 营销系统调用
- 补偿操作调用

### 4.2 监控与可观测性

**指标收集**:
- 交易请求计数(成功/失败)
- 交易处理耗时
- 外部系统调用耗时
- 断路器状态

**日志策略**:
- 结构化日志
- 关联ID追踪(correlationId)
- 分级日志(DEBUG/INFO/WARN/ERROR)

### 4.3 幂等性保证

通过唯一流水号保证幂等性:
- 格式: `SUB + YYYYMMDDHHMMSS + 6位序列号`
- 全局唯一
- 可用于请求去重

## 5. 数据库设计

### 5.1 核心表结构

**SUBSCRIPTION_TRANSACTION** (申购交易表):
- SERIAL_NUMBER (PK): 交易流水号
- CUSTOMER_ID: 客户ID
- PRODUCT_CODE: 产品代码
- SUBSCRIPTION_AMOUNT: 申购金额
- STATUS: 交易状态
- SAGA_STATE: Saga状态
- CORE_BANKING_TXN_ID: 核心系统交易ID
- FREEZE_ID: 冻结ID

**SHARE_RECORD** (份额记录表):
- ID (PK): 记录ID
- CUSTOMER_ID: 客户ID
- PRODUCT_CODE: 产品代码
- SHARE_AMOUNT: 份额数量(初始为0)
- STATUS: 状态

### 5.2 事务管理

- **本地事务**: 使用Spring `@Transactional`管理数据库事务
- **分布式事务**: 通过Saga模式协调，不使用2PC
- **补偿**: 异步补偿通过 `@Async` 执行

## 6. API设计

### 6.1 RESTful API

```
POST /api/v1/subscriptions
- 申购请求处理
- 同步返回结果

GET /api/v1/subscriptions/{serialNumber}
- 查询交易状态
```

### 6.2 错误处理

全局异常处理器统一处理:
- `ValidationException`: 400 Bad Request
- `BusinessException`: 400 Bad Request
- `ExternalSystemException`: 503 Service Unavailable
- `Exception`: 500 Internal Server Error

## 7. 部署架构

### 7.1 环境配置

- **开发环境** (dev): 详细日志、调试配置
- **生产环境** (prod): 优化性能、安全配置

### 7.2 依赖服务

- Oracle数据库 (21c+)
- 核心银行系统 (需实现接口)
- 营销系统 (需实现接口)

## 8. 扩展性考虑

### 8.1 未来演进方向

1. **微服务化**: 每个限界上下文可独立部署
2. **事件溯源**: 完整记录状态变更历史
3. **CQRS**: 读写分离提升查询性能
4. **消息队列**: 异步处理和事件发布
5. **分布式追踪**: 集成Zipkin/Jaeger

### 8.2 可扩展点

- 新增记账策略: 实现 `AccountingStrategy` 接口
- 新增验证规则: 扩展 `ValidationService`
- 新增限界上下文: 遵循相同的模块结构
- 新增外部系统: 定义ACL接口

## 9. 与原系统对比

| 方面 | 原系统(C) | 新系统(Java+DDD) |
|------|-----------|------------------|
| 语言 | C | Java 11 |
| 架构 | 过程式 | 领域驱动设计 |
| 模块化 | 紧耦合 | 限界上下文隔离 |
| 事务处理 | 不明确 | Saga模式 |
| 补偿处理 | 隐式 | 显式追踪和重试 |
| 扩展性 | 低 | 高(策略模式等) |
| 可测试性 | 低 | 高(依赖注入) |
| 可观测性 | 基础日志 | 指标+日志+追踪 |
| 弹性 | 无保护 | 断路器 |

## 10. 总结

本次重构通过引入领域驱动设计和现代架构模式，显著提升了系统的:

1. **可维护性**: 清晰的领域模型和职责划分
2. **可扩展性**: 开放封闭原则，易于添加新功能
3. **可靠性**: Saga补偿、断路器、重试机制
4. **可观测性**: 完整的监控和日志体系
5. **可测试性**: 依赖注入和清晰的层次结构

系统已为未来的演进(微服务化、事件驱动等)打下了坚实基础。


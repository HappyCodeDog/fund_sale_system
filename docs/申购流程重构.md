# 背景

* 原先的基金代销后台系统是用C语言编写的，计划使用JAVA语言重构
* 数据库及数据结构先保持不变，后续再迁移
* 重构要采用领域驱动设计思想，提升系统的可扩展性、可维护性

# 基金申购交易业务流程

## 1. 交易初始化与请求解析

系统接收来自前端的基金申购请求，执行以下操作：

* 解析类FIX格式的交易请求报文（详见类FIX报文格式说明）
* 提取交易请求的关键信息，包括客户信息、产品信息、交易金额等

## 2. 交易校验

系统执行多层校验确保交易的合规性和准确性：

### 2.1 产品信息校验

* 验证产品状态和交易状态是否允许申购
* 校验当前交易渠道是否满足产品要求

### 2.2 账户与份额校验

* 验证客户账户的有效性（客户、账户信息由核心系统同步，此处主要检查信息是否存在）
* 校验客户与产品信息的风险等级是否匹配

### 2.3 金额与额度校验

* 校验申购金额的合法性（产品首次申购/追加投资的最小、最大金额及最小单位限制）
* 校验是否满足按日累计TA总额度控制要求

## 3. 交易处理流程

### 3.1 生成交易流水号

* 为本次交易生成唯一的流水号
* 记录交易的基础信息

### 3.2 优惠券处理（如有）

* 如用户使用优惠券，先调用营销系统进行手续费优惠试算
* 根据试算结果计算使用优惠券后的实际手续费和费率
* 调用营销系统进行用券操作
* 保存优惠券使用记录

### 3.3 本地数据库操作

* 记录交易请求流水到数据库
* 如为首次申购，创建新的份额记录
* 采用事务处理确保数据一致性

### 3.4 账务交易处理

* 根据是否需要外币兑换以及当前是否在交易时间内，决定调用不同的核心系统接口
* 若需要外币兑换，调用核心系统"兑换+记账/冻结"接口
* 若不需要外币兑换且在交易时间内，调用核心系统的"记账"接口
* 若不需要外币兑换且不在交易时间内，调用核心系统的"冻结"接口（等待下一交易日解冻扣款）
* 处理核心系统返回结果，若失败（包括超时），需发起异步冲正

### 3.5 交易状态更新

* 更新交易请求表中的交易状态
* 若使用了优惠券，更新优惠券使用状态
* 更新投资适应性检查表的交易时间、交易流水号、集中度override问题标志等字段

### 3.6 短信/邮件通知及监控记录

* 记录短信发送信息
* 发送投资年期不匹配的邮件提醒
* 生成监控数据

## 4. 错误处理与回滚机制

* 交易失败时自动回滚所有已执行的操作
* 外币兑换由于汇率波动问题，无法冲正。此风险已事先告知客户
* 记账后回滚需异步调用核心系统冲正接口
* 冻结后回滚需异步调用核心系统解冻接口
* 用券后回滚需异步调用营销系统还券接口
* 生成相应的错误应答信息

## 5. 结果返回

* 生成交易应答报文，返回交易成功或失败信息
* 包含必要的交易信息，如客户编号、产品信息、交易金额、状态等
* 如有错误，返回详细的错误码和错误信息

